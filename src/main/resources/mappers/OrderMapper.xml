<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aris.javaweb_vtd.mapper.OrderMapper">
    <insert id="insertOrder" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO orders 
        (total_price
        ,status
        ,customer_id
        ,shipping_fee
        ,created_at
        ,updated_at)
        VALUES 
        (#{totalPrice}
        ,#{status}
        ,#{customerId}
        ,#{shippingFee}
        ,#{createdAt}
        ,#{updatedAt})
    </insert>

    <select id="getOrdersByFilters" parameterType="map" resultType="com.aris.javaweb_vtd.dto.response.OrderSummaryDTO">
      SELECT
        o.id AS id
        ,o.status AS status
        ,o.total_price AS totalPrice
        ,o.created_at AS createAt

        ,MIN(i.id) AS itemId
        ,MIN(i.name) AS itemName
        ,MIN(i.description) AS itemDescription
        ,MIN(i.image) AS itemImage
        ,MIN(i.type) AS itemType
        ,MIN(od.quantity) AS quantity
        ,MIN(od.price) AS price
        

        ,SUM(od.quantity) AS totalItems
        ,SUM(od.quantity * od.price) AS subTotal

      FROM orders o
      LEFT JOIN order_details od ON od.order_id = o.id
      LEFT JOIN items i ON od.item_id = i.id

      <where>
        <if test="statusList != null and statusList.size > 0">
          o.status IN
          <foreach collection="statusList" item="status" open="(" separator="," close=")">
            #{status}
          </foreach>
        </if>

        <if test="fromDate != null">
          AND o.created_at &gt;= #{fromDate}
        </if>
        <if test="toDate != null">
          AND o.created_at &lt;= #{toDate}
        </if>
      </where>

      GROUP BY o.id, o.status, o.total_price, o.created_at
      ORDER BY o.id DESC
    </select>

    <!-- Map field belongs to OrderDetail - Item object -->
    <resultMap id="OrderItemMap" type="com.aris.javaweb_vtd.dto.response.OrderItemResponseDTO">
      <id property="id" column="item_id" />
      <result property="name" column="item_name"/>
      <result property="description" column="item_description"/>
      <result property="img" column="item_image"/>
      <result property="type" column="item_type"/>
      <result property="price" column="order_detail_price"/>
      <result property="quantity" column="order_detail_quantity"/>
    </resultMap>

    <!-- Map field belongs to Order object -->
    <resultMap id="OrderResponseDTO" type="com.aris.javaweb_vtd.dto.response.OrderResponseDTO">
      <id property="id" column="order_id"/>
      <result property="status" column="status"/>
      <result property="totalPrice" column="total_price"/>
      <result property="createAt" column="created_at"/>
      <result property="totalItems" column="total_items"/>
      <result property="subTotal" column="sub_total"/>
      <association property="customer" javaType="com.aris.javaweb_vtd.dto.response.CustomerResponseDTO" resultMap="CustomerMap"/>
      <collection property="items" ofType="com.aris.javaweb_vtd.dto.response.OrderItemResponseDTO" resultMap="OrderItemMap"/>
    </resultMap>

    <!-- Map field belongs to Customer object -->
    <resultMap id="CustomerMap" type="com.aris.javaweb_vtd.dto.response.CustomerResponseDTO">
      <id property="id" column="customer_id"/>
      <result property="fullName" column="full_name"/>
      <result property="phone" column="phone"/>
      <result property="city" column="city"/>
      <result property="ward" column="ward"/>
      <result property="address" column="address"/>
      <result property="message" column="message"/>
    </resultMap>

</mapper>